{% extends "base.html" %}
{% load staticfiles %}
{% load widget_tweaks %}

{% block stylesheets %}

{{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'css/modal.css' %}">
  <!-- Include Bootstrap Datepicker -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker3.min.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css" />
{% endblock stylesheets %}

{% block js %}

{{ block.super }}
  <script type="text/javascript" src="{% static 'js/persons.js' %}"></script>
  <script type="text/javascript">
    var personListUrl = "{% url 'person-list' %}",
        personSeasonListUrl = "{% url 'personseason-list' %}",
        personUpdate = "{% url 'persons_detail' pk=object.pk %}",
        person = {{ object.pk }};
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>

{% endblock js %}


{% block content %}

<div class="form-group">
  <label class="control-label" for="focusedInput">&nbsp;</label>
  <div class="input-group">
    <input type="text" class="form-control" id="person-input" />
    <span class="input-group-btn">
      <button class="btn btn-default" id="search-submit-btn" type="button">Искать</button>
    </span>
  </div>
</div>

<span id="indicator" style="display:none;"><img src="http://upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif"/></span>
<div id="results"></div>

<div id="formErrors">
{% if form.errors %}
    {{ form.non_field_errors }}
    {% for field in form %}
    <div class="fieldError">
        {{ field.errors }}
    </div>
    {% endfor %}
{% endif %}
</div>

<h2 id="name" class="editable">{{ object.full_name }}</h2>


<form role="form" id="personForm"
      method="POST" action="{% url 'persons_detail' pk=object.pk %}">
{% csrf_token %}
<div id="nameForm" class="form-inputs" style="display: none;">
  <div class="form-inline row">
    <div class="col-sm-4">
      {% render_field form.name class+="form-control" %}
      <span class="help-block">{{ form.name.label }}</span>
    </div>
    <div class="col-sm-4">
      {% render_field form.first_name class+="form-control" %}
      <span class="help-block">{{ form.first_name.label }}</span>
    </div>
    <div class="col-sm-4">
      {% render_field form.middle_name class+="form-control" %}
      <span class="help-block">{{ form.middle_name.label }}</span>
    </div>
  </div>
</div>
<div id="storyForm" class="form-inputs" style="display: none;">
  <div class="form-group">
    {% render_field form.story class+="form-control" rows="5" %}
    <span class="help-block">{{ form.story.label }}</span>
  </div>
</div>
<div id="dossierForm" class="form-inputs" style="display: none;">
  <div class="form-group row">
    <div class="col-sm-2">
      {% render_field form.year class+="form-control" %}
      <span class="help-block">{{ form.year.label }}</span>
    </div>
    <div class="col-sm-3">
      <div class="input-group input-append date">
        {% render_field form.dob class+="form-control" %}
        <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span></span>
      </div>
        <span class="help-block">{{ form.dob.label }}</span>
    </div>
    <div class="col-sm-2">
      {% render_field form.year_death class+="form-control" %}
      <span class="help-block">{{ form.year_death.label }}</span>
    </div>
    <div class="col-sm-3">
      <div class="input-group input-append date">
        {% render_field form.dod class+="form-control" %}
        <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span></span>
      </div>
        <span class="help-block">{{ form.dod.label }}</span>
    </div>
    <div class="col-sm-2">
      {% render_field form.is_dead class+="form-control" %}
      <span class="help-block">{{ form.is_dead.label }}</span>
    </div>

  </div>
</div>
<div id="submitForm" style="display: none;">
  <div class="form-group">
    <button class="btn btn-default" id="submitPersonForm" type="submit">Сохранить</button>
    <button class="btn btn-secondary" id="cancelPersonForm" type="submit">Отмена</button>
  </div>
</div>
</form>
<div id="dossier" class="editable">
  {% if "-" in object.living_years %}
    <b>Годы жизни:</b> {{ object.living_years }}
  {% else %}
    <b>Дата рождения:</b> {{ object.living_years }}
  {% endif %}
</div>
<div id="story" class="editable">
  <b>История:</b>
  <div>{{ object.story | safe }}</div>
</div>
<form role="form" id="addPersonSeason" style="display: none;">
{% csrf_token %}
<div class="form-inputs">
  <div class="form-group has-error">
    <div class="col-sm-2">
      {% render_field season_form.year class+="form-control" %}
      <span class="help-block">{{ season_form.year.label }}</span>
    </div>
    <div class="col-sm-2">
      {% render_field season_form.role class+="form-control" %}
      <span class="help-block">{{ season_form.role.label }}</span>
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-4">
      {% render_field season_form.tournament class+="form-control" %}
      <span class="help-block">{{ season_form.tournament.label }}</span>
    </div>
    <div class="col-sm-4">
      {% render_field season_form.team class+="form-control" style="width: 100%" %}
      <span class="help-block">{{ season_form.team.label }}</span>
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-12">
      {% render_field season_form.story class+="form-control" rows="2" %}
      <span class="help-block">{{ season_form.story.label }}</span>
    </div>
  </div>
</div>

  <div class="pull-right">
    <button class="btn btn-default" id="submitPersonSeasonForm" type="button">Сохранить</button>
    <button class="btn btn-secondary" id="cancelPersonSeasonForm" type="button">Отмена</button>
  </div>
</form>
  <div class="pull-right">
    <button class="btn btn-default" id="showPersonSeasonForm" type="button">Добавить</button>
  </div>

<h4>Сезоны</h4>
{% if object.seasons.all %}
<table class="table table-striped table-hover" id="person-seasons">
<thead>
  <tr>
    <th>Год</th>
    <th>Амплуа</th>
    <th>Турнир</th>
    <th>Команда</th>
    <th>Комментарии</th>
  </tr>
</thead>
<tbody>
{% for season in object.seasons.all %}
  <tr class="document-row">
    <td> {{ season.year }} </td>
    <td> {{ season.role_verbose }} </td>
    <td> 
    {% if season.tournament %}
      <a class="link" href="#">
         {{ season.tournament }}
      </a>
    {% else %}
      -
    {% endif %}
    </td>
    <td>
    {% if season.team %}
      {{ season.team.short_name }}
    {% else %}
      -
    {% endif %}
    </td>
    <td> {{ season.story }} </td>
  </tr>
{% endfor %}
</tbody></table>
{% endif %}

{% if object.documents %}
<h4>Документы</h4>
<table class="table table-striped table-hover" id="documents-table">
  <thead>
    <tr>
      <th>Заголовок</th>
      <th>Описание</th>
      <th>Месяц/Год</th>
      <th>Ссылка</th>
    </tr>
  </thead>
  <tbody>
    
  {% for doc in object.documents %}
  <tr class="document-row">
    <td> {{ doc.title }} </td>
    <td> {{ doc.description }} </td>
    <td> {{ doc.date }} </td>
    <td> {% if doc.is_image %}
      <a class="dropbox-link" 
         href="{{ doc.dropbox_path }}">
         <img src="{{ doc.dropbox_thumb }}"/>
      </a>
    {% else %}
      <a class="dropbox-link" 
         href="{{ doc.dropbox_path }}">
         Нет превью
      </a>
    {% endif %}
    </td>
  </tr>
  {% endfor %}

  </tbody>
</table>

{% endif %}

{% include '_modal.html' with modal_id="moderationModal" %}

{% endblock content %}
